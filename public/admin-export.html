<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å˜‰ç¾©ç‰›è‚‰éºµ - ä»Šæ—¥ç‡Ÿæ”¶åŒ¯å‡º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Microsoft YaHei", "å¾®è»Ÿé›…é»‘", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
    }

    /* çµ±è¨ˆå¡ç‰‡ */
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-label {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .stat-icon {
      font-size: 32px;
      margin-top: 10px;
    }

    /* è¨‚å–®åˆ—è¡¨ */
    .orders-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .orders-section h3 {
      color: #333;
      margin-bottom: 20px;
      font-size: 18px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .orders-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .orders-table thead th {
      background: #f0f0f0;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #ddd;
    }

    .orders-table tbody tr {
      border-bottom: 1px solid #eee;
      transition: background 0.2s;
    }

    .orders-table tbody tr:hover {
      background: #f9f9f9;
    }

    .orders-table tbody td {
      padding: 12px;
      color: #555;
    }

    .orders-table .amount {
      font-weight: 600;
      color: #27ae60;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #999;
    }
  </style>
</head>
<style>
    /* æ“ä½œæŒ‰éˆ• */
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-refresh {
      background: #3498db;
      color: white;
    }

    .btn-refresh:hover:not(:disabled) {
      background: #2980b9;
      transform: scale(1.05);
    }

    .btn-export {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-export:hover:not(:disabled) {
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      transform: scale(1.05);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* ç¢ºèªå°è©±æ¡† */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-content h4 {
      color: #333;
      margin-bottom: 15px;
      font-size: 20px;
    }

    .modal-content p {
      color: #666;
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .settlement-info {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 14px;
    }

    .settlement-info strong {
      color: #27ae60;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn-cancel, .btn-confirm {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-cancel {
      background: #ecf0f1;
      color: #333;
    }

    .btn-cancel:hover {
      background: #bdc3c7;
    }

    .btn-confirm {
      background: #27ae60;
      color: white;
    }

    .btn-confirm:hover {
      background: #229954;
    }
  </style>
</head>
<style>
    /* æˆåŠŸè¨Šæ¯ */
    .success-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border-left: 4px solid #27ae60;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      z-index: 2000;
      animation: slideInRight 0.3s ease;
      max-width: 350px;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .success-content {
      display: flex;
      gap: 15px;
      align-items: flex-start;
    }

    .success-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .success-title {
      color: #27ae60;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .success-file {
      color: #666;
      font-size: 13px;
      margin-top: 5px;
    }

    /* åŠ è¼‰ç‹€æ…‹ */
    .loading-spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 2000;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-spinner p {
      color: white;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 24px;
      }

      .stats-cards {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .modal-content {
        margin: 20px;
        max-width: 90%;
      }

      .success-message {
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }
  </style>
</head>
<body>
   <div class="container">
    <!-- æ¨™é¡Œ -->
    <div class="header">
      <h1>ğŸ“Š å˜‰ç¾©ç‰›è‚‰éºµ</h1>
      <p>ä»Šæ—¥ç‡Ÿæ”¶çµ±è¨ˆ & ExcelåŒ¯å‡º</p>
    </div>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-label">ä»Šæ—¥ç‡Ÿæ”¶</div>
        <div class="stat-value" id="totalRevenue">NT$0.00</div>
        <div class="stat-icon">ğŸ’°</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">è¨‚å–®æ•¸</div>
        <div class="stat-value" id="totalOrders">0</div>
        <div class="stat-icon">ğŸ“¦</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å•†å“æ•¸</div>
        <div class="stat-value" id="totalItems">0</div>
        <div class="stat-icon">ğŸœ</div>
      </div>
    </div>

    <!-- è¨‚å–®æ˜ç´° -->
    <div class="orders-section">
      <h3>ğŸ“‹ ä»Šæ—¥è¨‚å–®æ˜ç´°</h3>
      <table class="orders-table" id="ordersTable">
        <thead>
          <tr>
            <th>è¨‚å–®ç·¨è™Ÿ</th>
            <th>å®¢æˆ¶</th>
            <th>é‡‘é¡</th>
            <th>å•†å“æ•¸</th>
            <th>æ™‚é–“</th>
          </tr>
        </thead>
        <tbody id="ordersTableBody">
          <tr>
            <td colspan="5" class="no-data">åŠ è¼‰ä¸­...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="action-buttons">
      <button class="btn btn-refresh" onclick="refreshData()" id="refreshBtn">
        ğŸ”„ é‡æ–°æ•´ç†
      </button>
      <button class="btn btn-export" onclick="showExportConfirm()" id="exportBtn">
        ğŸ“Š åŒ¯å‡ºExcelä¸¦çµç®—
      </button>
    </div>
  </div>

  <!-- ç¢ºèªå°è©±æ¡† -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal-content">
      <h4>ç¢ºèªçµç®—</h4>
      <p>ç¢ºå®šè¦åŒ¯å‡ºExcelä¸¦çµç®—ä»Šæ—¥ç‡Ÿæ”¶å—ï¼Ÿ</p>
      <div class="settlement-info">
        ç‡Ÿæ”¶: <strong id="confirmRevenue">NT$0.00</strong><br>
        è¨‚å–®æ•¸: <strong id="confirmOrders">0</strong><br>
        æ—¥æœŸ: <strong id="confirmDate">-</strong>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeConfirm()">å–æ¶ˆ</button>
        <button class="btn-confirm" onclick="confirmExport()">ç¢ºèªåŒ¯å‡º</button>
      </div>
    </div>
  </div>

  <!-- æˆåŠŸè¨Šæ¯ -->
  <div class="success-message" id="successMsg" style="display: none;">
    <div class="success-content">
      <span class="success-icon">âœ…</span>
      <div>
        <p class="success-title" id="successTitle">åŒ¯å‡ºæˆåŠŸï¼</p>
        <p class="success-file" id="successFile">æª”æ¡ˆ: -</p>
      </div>
    </div>
  </div>

  <!-- åŠ è¼‰ç‹€æ…‹ -->
  <div class="loading-spinner" id="loadingSpinner" style="display: none;">
    <div class="spinner"></div>
    <p>è™•ç†ä¸­...</p>
  </div>

</body>
<script>
  // å…¨å±€è®Šæ•¸
  let revenueData = {
    date: '',
    totalRevenue: '0.00',
    totalOrders: 0,
    totalItems: 0,
    orders: []
  };
  let isLoading = false;
  let isSettled = false;

  // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    refreshData();
  });

  // é‡æ–°æ•´ç†æ•¸æ“š
  async function refreshData() {
    if (isLoading) return;
    
    isLoading = true;
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.disabled = true;

    try {
      const response = await fetch('/api/export/daily-revenue');
      const data = await response.json();

      if (data.success) {
        revenueData = data;
        updateUI();
      } else {
        alert('å–å¾—ç‡Ÿæ”¶æ•¸æ“šå¤±æ•—: ' + data.error);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('ç¶²è·¯é€£ç·šéŒ¯èª¤: ' + error.message);
    } finally {
      isLoading = false;
      refreshBtn.disabled = false;
    }
  }

  // æ›´æ–°UI
  function updateUI() {
    // æ›´æ–°çµ±è¨ˆå¡ç‰‡
    document.getElementById('totalRevenue').textContent = `NT$${revenueData.totalRevenue}`;
    document.getElementById('totalOrders').textContent = revenueData.totalOrders;
    document.getElementById('totalItems').textContent = revenueData.totalItems;

    // æ›´æ–°è¨‚å–®è¡¨æ ¼
    const tbody = document.getElementById('ordersTableBody');
    
    if (revenueData.orders.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="no-data">ä»Šæ—¥æš«ç„¡å·²æ”¯ä»˜è¨‚å–®</td></tr>';
      return;
    }

    tbody.innerHTML = revenueData.orders.map(order => {
      const orderTime = new Date(order.createdAt).toLocaleString('zh-TW');
      const orderId = order.id ? order.id.toString().slice(-8) : 'N/A';
      const amount = typeof order.total === 'number' ? order.total.toFixed(2) : '0.00';
      const itemCount = Array.isArray(order.items) ? order.items.length : 0;

      return `
        <tr>
          <td>${orderId}</td>
          <td>${order.name || 'æœªçŸ¥'}</td>
          <td class="amount">NT$${amount}</td>
          <td>${itemCount}</td>
          <td>${orderTime}</td>
        </tr>
      `;
    }).join('');
  }

  // é¡¯ç¤ºåŒ¯å‡ºç¢ºèªå°è©±æ¡†
  function showExportConfirm() {
    if (isSettled) {
      alert('ä»Šæ—¥å·²çµç®—ï¼Œç„¡æ³•å†åŒ¯å‡º');
      return;
    }

    if (revenueData.totalOrders === 0) {
      alert('ä»Šæ—¥æ²’æœ‰å·²æ”¯ä»˜è¨‚å–®ï¼Œç„¡æ³•åŒ¯å‡º');
      return;
    }

    // æ›´æ–°ç¢ºèªå°è©±æ¡†å…§å®¹
    document.getElementById('confirmRevenue').textContent = `NT$${revenueData.totalRevenue}`;
    document.getElementById('confirmOrders').textContent = revenueData.totalOrders;
    document.getElementById('confirmDate').textContent = new Date(revenueData.date).toLocaleDateString('zh-TW');

    // é¡¯ç¤ºå°è©±æ¡†
    document.getElementById('confirmModal').classList.add('show');
  }

  // é—œé–‰ç¢ºèªå°è©±æ¡†
  function closeConfirm() {
    document.getElementById('confirmModal').classList.remove('show');
  }

  // ç¢ºèªåŒ¯å‡º
  async function confirmExport() {
    closeConfirm();
    
    if (isLoading) return;
    
    isLoading = true;
    document.getElementById('loadingSpinner').style.display = 'block';
    const exportBtn = document.getElementById('exportBtn');
    exportBtn.disabled = true;

    try {
      const response = await fetch('/api/export/export-and-settle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const result = await response.json();

      if (result.success) {
        isSettled = true;
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        showSuccessMessage(result.fileName, result.data);

        // 3ç§’å¾Œè‡ªå‹•éš±è—æˆåŠŸè¨Šæ¯
        setTimeout(() => {
          hideSuccessMessage();
        }, 5000);

        // åˆ·æ–°æ•¸æ“š
        await refreshData();
      } else {
        alert('åŒ¯å‡ºå¤±æ•—: ' + result.error);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('åŒ¯å‡ºå¤±æ•—: ' + error.message);
    } finally {
      isLoading = false;
      document.getElementById('loadingSpinner').style.display = 'none';
      exportBtn.disabled = isSettled;
    }
  }

  // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
  function showSuccessMessage(fileName, data) {
    const successMsg = document.getElementById('successMsg');
    const successTitle = document.getElementById('successTitle');
    const successFile = document.getElementById('successFile');

    successTitle.textContent = `âœ… åŒ¯å‡ºæˆåŠŸï¼ç‡Ÿæ”¶ NT$${data.totalRevenue}`;
    successFile.textContent = `æª”æ¡ˆ: ${fileName} | è¨‚å–®æ•¸: ${data.totalOrders}`;

    successMsg.style.display = 'block';
  }

  // éš±è—æˆåŠŸè¨Šæ¯
  function hideSuccessMessage() {
    document.getElementById('successMsg').style.display = 'none';
  }

  // é»æ“Šå°è©±æ¡†å¤–éƒ¨é—œé–‰
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('confirmModal');
    if (e.target === modal) {
      closeConfirm();
    }
  });
</script>
</body>
</html>

